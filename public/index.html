<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ryan's Suit ‚Äî ÁõëÊéß‰∏≠Êû¢</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #0f0f1a;
    --surface2: #141420;
    --border: #1e1e35;
    --accent: #00ff88;
    --accent2: #7c3aff;
    --warn: #ff6b35;
    --danger: #ff2d55;
    --muted: #3a3a5c;
    --text: #e8e8f0;
    --text2: #7878a0;
    --mono: 'JetBrains Mono', monospace;
    --sans: 'Syne', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    animation: pulse-glow 3s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 20px rgba(0,255,136,0.3); }
    50% { box-shadow: 0 0 40px rgba(0,255,136,0.6), 0 0 80px rgba(0,255,136,0.2); }
  }

  .logo-text h1 {
    font-family: var(--sans);
    font-size: 18px;
    font-weight: 800;
    letter-spacing: -0.5px;
  }

  .logo-text span {
    font-size: 11px;
    color: var(--text2);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  /* Language toggle button */
  .lang-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text2);
    cursor: pointer;
    font-family: var(--mono);
    transition: all 0.2s;
    letter-spacing: 1px;
  }
  .lang-btn:hover {
    color: var(--accent);
    border-color: rgba(0,255,136,0.3);
    background: rgba(0,255,136,0.05);
  }
  .lang-btn .lang-active {
    color: var(--accent);
    font-weight: 700;
  }

  .status-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid;
    transition: all 0.3s;
  }

  .status-badge.online {
    color: var(--accent);
    border-color: rgba(0,255,136,0.3);
    background: rgba(0,255,136,0.05);
  }

  .status-badge.offline {
    color: var(--danger);
    border-color: rgba(255,45,85,0.3);
    background: rgba(255,45,85,0.05);
  }

  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: currentColor;
  }

  .status-badge.online .status-dot {
    animation: blink 1.5s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .time-display {
    font-size: 12px;
    color: var(--text2);
    letter-spacing: 1px;
  }

  .stats-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent-color, var(--accent)), transparent);
    opacity: 0.6;
  }

  .stat-card:hover { border-color: var(--muted); }

  .stat-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text2);
    margin-bottom: 8px;
  }

  .stat-value {
    font-family: var(--sans);
    font-size: 28px;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-sub {
    font-size: 10px;
    color: var(--text2);
  }

  .main-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 20px;
    margin-bottom: 20px;
  }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
  }

  .panel-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text2);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-title-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--accent);
  }

  .panel-action {
    font-size: 10px;
    color: var(--text2);
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    transition: all 0.2s;
    background: none;
    font-family: var(--mono);
  }

  .panel-action:hover {
    color: var(--accent);
    border-color: rgba(0,255,136,0.3);
    background: rgba(0,255,136,0.05);
  }

  .log-stream {
    padding: 12px;
    height: 420px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
    scroll-behavior: smooth;
  }

  .log-stream::-webkit-scrollbar { width: 4px; }
  .log-stream::-webkit-scrollbar-track { background: transparent; }
  .log-stream::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 2px; }

  .log-entry {
    display: grid;
    grid-template-columns: 60px 55px 80px 1fr;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 11px;
    line-height: 1.5;
    border: 1px solid transparent;
    transition: all 0.2s;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .log-entry:hover {
    background: var(--surface2);
    border-color: var(--border);
  }

  .log-entry.info .log-level { color: var(--accent); }
  .log-entry.warn { background: rgba(255,107,53,0.04); }
  .log-entry.warn .log-level { color: var(--warn); }
  .log-entry.error { background: rgba(255,45,85,0.06); border-color: rgba(255,45,85,0.15); }
  .log-entry.error .log-level { color: var(--danger); }
  .log-entry.tool { background: rgba(124,58,255,0.05); }
  .log-entry.tool .log-level { color: var(--accent2); }

  .log-time { color: var(--muted); font-size: 10px; }
  .log-level { font-weight: 700; font-size: 10px; text-transform: uppercase; }
  .log-source { color: var(--text2); font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .log-msg { color: var(--text); word-break: break-word; }
  .log-msg .highlight { color: var(--accent); font-weight: 500; }
  .log-msg .path { color: var(--accent2); }
  .log-msg .cmd { color: var(--warn); font-family: var(--mono); background: rgba(255,107,53,0.1); padding: 1px 4px; border-radius: 3px; }

  .alerts-list {
    padding: 10px;
    height: 420px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .alert-item {
    padding: 12px;
    border-radius: 10px;
    border: 1px solid;
    animation: fadeIn 0.3s ease;
    cursor: pointer;
    transition: all 0.2s;
  }

  .alert-item:hover { transform: translateX(3px); }

  .alert-item.critical {
    border-color: rgba(255,45,85,0.3);
    background: rgba(255,45,85,0.06);
  }

  .alert-item.warning {
    border-color: rgba(255,107,53,0.3);
    background: rgba(255,107,53,0.06);
  }

  .alert-item.info {
    border-color: rgba(0,255,136,0.2);
    background: rgba(0,255,136,0.04);
  }

  .alert-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }

  .alert-type {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 700;
  }

  .alert-item.critical .alert-type { color: var(--danger); }
  .alert-item.warning .alert-type { color: var(--warn); }
  .alert-item.info .alert-type { color: var(--accent); }

  .alert-time { font-size: 9px; color: var(--text2); }
  .alert-msg { font-size: 11px; color: var(--text); line-height: 1.5; }
  .alert-detail { font-size: 10px; color: var(--text2); margin-top: 4px; }

  .bottom-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
  }

  .tool-list {
    padding: 10px;
    height: 240px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .tool-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface2);
    font-size: 11px;
    animation: fadeIn 0.3s ease;
    transition: all 0.2s;
  }

  .tool-item:hover { border-color: var(--muted); }

  .tool-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    flex-shrink: 0;
  }

  .tool-icon.shell { background: rgba(255,107,53,0.15); }
  .tool-icon.fs { background: rgba(124,58,255,0.15); }
  .tool-icon.web { background: rgba(0,255,136,0.1); }
  .tool-icon.memory { background: rgba(255,200,50,0.1); }
  .tool-icon.msg { background: rgba(0,160,255,0.1); }

  .tool-info { flex: 1; overflow: hidden; }
  .tool-name { font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tool-args { font-size: 10px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .tool-status {
    font-size: 9px;
    padding: 2px 7px;
    border-radius: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .tool-status.ok { background: rgba(0,255,136,0.1); color: var(--accent); }
  .tool-status.running { background: rgba(124,58,255,0.15); color: var(--accent2); animation: blink 1s infinite; }
  .tool-status.err { background: rgba(255,45,85,0.1); color: var(--danger); }

  .chart-area {
    padding: 16px;
    height: 240px;
    display: flex;
    flex-direction: column;
  }

  .chart-bars {
    flex: 1;
    display: flex;
    align-items: flex-end;
    gap: 3px;
    padding-top: 10px;
  }

  .chart-bar-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    height: 100%;
    justify-content: flex-end;
  }

  .chart-bar {
    width: 100%;
    border-radius: 3px 3px 0 0;
    min-height: 2px;
    transition: height 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    cursor: pointer;
  }

  .chart-bar.normal { background: linear-gradient(180deg, var(--accent), rgba(0,255,136,0.4)); }
  .chart-bar.high { background: linear-gradient(180deg, var(--warn), rgba(255,107,53,0.4)); }
  .chart-bar.peak { background: linear-gradient(180deg, var(--danger), rgba(255,45,85,0.4)); }
  .chart-bar:hover::after {
    content: attr(data-val);
    position: absolute;
    top: -22px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 9px;
    color: var(--text);
    background: var(--surface2);
    padding: 2px 5px;
    border-radius: 3px;
    white-space: nowrap;
  }

  .chart-labels {
    display: flex;
    gap: 3px;
    margin-top: 6px;
  }

  .chart-label {
    flex: 1;
    text-align: center;
    font-size: 8px;
    color: var(--muted);
  }

  .memory-display {
    padding: 14px 16px;
    height: 360px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .memory-bar-wrap {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .memory-bar-header {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
  }

  .memory-bar-label { color: var(--text2); }
  .memory-bar-val { color: var(--text); font-weight: 600; }

  .memory-bar-bg {
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
  }

  .memory-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 1s ease;
  }

  .memory-bar-fill.green { background: linear-gradient(90deg, var(--accent), rgba(0,255,136,0.6)); }
  .memory-bar-fill.purple { background: linear-gradient(90deg, var(--accent2), rgba(124,58,255,0.6)); }
  .memory-bar-fill.orange { background: linear-gradient(90deg, var(--warn), rgba(255,107,53,0.6)); }
  .memory-bar-fill.blue { background: linear-gradient(90deg, #00a0ff, rgba(0,160,255,0.6)); }

  .config-section { padding: 16px; }

  .config-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
  }

  .config-row:last-child { border-bottom: none; }
  .config-key { color: var(--text2); }
  .config-val { color: var(--accent); font-weight: 500; }
  .config-val.warn { color: var(--warn); }
  .config-val.ok { color: var(--accent); }
  .config-val.muted { color: var(--muted); }

  .toggle {
    position: relative;
    width: 32px;
    height: 17px;
    flex-shrink: 0;
  }

  .toggle input { display: none; }

  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--muted);
    border-radius: 17px;
    cursor: pointer;
    transition: 0.3s;
  }

  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 11px;
    height: 11px;
    border-radius: 50%;
    background: white;
    top: 3px;
    left: 3px;
    transition: 0.3s;
  }

  .toggle input:checked + .toggle-slider { background: var(--accent); }
  .toggle input:checked + .toggle-slider::before { transform: translateX(15px); }

  ::-webkit-scrollbar { width: 3px; height: 3px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 2px; }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--muted);
    font-size: 11px;
    gap: 8px;
  }

  .empty-icon { font-size: 28px; opacity: 0.4; }

  .log-path-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 6px;
    outline: none;
    min-width: 0;
  }
  .log-path-input:focus { border-color: var(--accent); }
  .log-path-input::placeholder { color: var(--muted); }

  .connect-row {
    display: flex;
    gap: 8px;
    align-items: center;
    flex: 1;
  }

  .gateway-input {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 6px;
    outline: none;
    width: 180px;
  }
  .gateway-input:focus { border-color: var(--accent); }

  .btn-connect {
    font-size: 10px;
    color: var(--accent);
    border: 1px solid rgba(0,255,136,0.3);
    background: rgba(0,255,136,0.05);
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-family: var(--mono);
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-connect:hover { background: rgba(0,255,136,0.12); }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header>
    <div class="logo">
      <div class="logo-icon">ü¶û</div>
      <div class="logo-text">
        <h1 id="suitTitle" style="cursor:default;">Ryan's Suit Monitor</h1>
        <span id="suitSubtitle">OpenClaw ¬∑ ÂÖ®Ê†àË∞ÉÁî®ÁõëÊéß‰∏≠Êû¢</span>
      </div>
      <div id="nameEditWrap" style="margin-left:12px;display:none;align-items:center;gap:6px;">
        <input id="nameEditInput" type="text"
          style="background:var(--surface2);border:1px solid var(--accent);color:var(--text);font-family:var(--mono);font-size:12px;padding:4px 8px;border-radius:6px;outline:none;width:130px;" />
        <button onclick="saveName()" id="nameSaveBtn" style="font-size:10px;color:var(--accent);border:1px solid rgba(0,255,136,0.3);background:rgba(0,255,136,0.05);padding:4px 8px;border-radius:6px;cursor:pointer;font-family:var(--mono);"></button>
        <button onclick="cancelEditName()" id="nameCancelBtn" style="font-size:10px;color:var(--text2);border:1px solid var(--border);background:none;padding:4px 8px;border-radius:6px;cursor:pointer;font-family:var(--mono);"></button>
      </div>
      <button onclick="editName()" id="nameEditBtn" title="Rename"
        style="margin-left:8px;background:none;border:1px solid var(--border);color:var(--text2);font-size:10px;padding:3px 8px;border-radius:6px;cursor:pointer;font-family:var(--mono);transition:all 0.2s;"
        onmouseover="this.style.color='var(--accent)';this.style.borderColor='rgba(0,255,136,0.3)'"
        onmouseout="this.style.color='var(--text2)';this.style.borderColor='var(--border)'">‚úèÔ∏è <span id="btnRename"></span></button>
    </div>
    <div class="header-right">
      <!-- Language Toggle -->
      <button class="lang-btn" onclick="toggleLang()" id="langBtn">
        <span id="langZh" class="lang-active">‰∏≠Êñá</span>
        <span style="color:var(--muted)">|</span>
        <span id="langEn">EN</span>
      </button>
      <div class="connect-row">
        <span id="labelLogService" style="font-size:10px;color:var(--text2);white-space:nowrap;"></span>
        <input class="gateway-input" id="logApiUrl" value="http://127.0.0.1:19999/logs" placeholder="http://127.0.0.1:19999/logs" style="width:220px;" />
        <button class="btn-connect" onclick="startPolling()" id="btnStart"></button>
        <button class="btn-connect" onclick="stopPolling()" id="btnStop" style="color:var(--danger);border-color:rgba(255,45,85,0.3);background:rgba(255,45,85,0.05);"></button>
      </div>
      <div class="status-badge offline" id="statusBadge">
        <div class="status-dot"></div>
        <span id="statusText"></span>
      </div>
      <div class="time-display" id="clock">--:--:--</div>
    </div>
  </header>

  <!-- Spending + Model bar -->
  <div style="display:flex;align-items:stretch;gap:0;margin-bottom:20px;background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;">
    <div style="display:flex;align-items:center;gap:14px;padding:14px 24px;flex:1;border-right:1px solid var(--border);">
      <div style="width:36px;height:36px;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">üí∞</div>
      <div>
        <div style="font-size:9px;text-transform:uppercase;letter-spacing:2px;color:var(--text2);margin-bottom:4px;">SPENDING</div>
        <div style="font-family:var(--sans);font-size:22px;font-weight:800;color:var(--accent);line-height:1;" id="headerCostTotal">$0.00</div>
      </div>
      <div style="margin-left:16px;display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:10px;color:var(--text2);"><span id="labelToday"></span>: <span id="headerCostDay" style="color:var(--text);">$0.00</span></div>
        <div style="font-size:10px;color:var(--text2);"><span id="labelMonth"></span>: <span id="headerCostMonth" style="color:var(--text);">$0.00</span></div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:20px;padding:14px 24px;border-right:1px solid var(--border);">
      <div>
        <div style="font-size:9px;text-transform:uppercase;letter-spacing:2px;color:var(--text2);margin-bottom:4px;">TOKENS</div>
        <div style="font-family:var(--sans);font-size:18px;font-weight:700;color:var(--text);line-height:1;" id="headerTokenTotal">‚Äî</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px;">
        <div style="font-size:10px;color:var(--text2);"><span id="labelInput"></span>: <span id="headerTokenIn" style="color:var(--text);">‚Äî</span></div>
        <div style="font-size:10px;color:var(--accent2);"><span id="labelOutput"></span>: <span id="headerTokenOut" style="color:var(--accent2);">‚Äî</span></div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:14px;padding:14px 24px;">
      <div style="width:36px;height:36px;background:rgba(124,58,255,0.1);border:1px solid rgba(124,58,255,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;">ü§ñ</div>
      <div>
        <div style="font-size:9px;text-transform:uppercase;letter-spacing:2px;color:var(--text2);margin-bottom:4px;">MODEL</div>
        <div style="font-family:var(--sans);font-size:15px;font-weight:700;color:var(--accent2);line-height:1;" id="headerModel">kimi-k2.5</div>
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card" style="--accent-color: var(--accent)">
      <div class="stat-label" id="labelStatTotal"></div>
      <div class="stat-value" style="color:var(--accent)" id="statTotal">0</div>
      <div class="stat-sub" id="subStatTotal"></div>
    </div>
    <div class="stat-card" style="--accent-color: var(--accent2)">
      <div class="stat-label" id="labelStatShell"></div>
      <div class="stat-value" style="color:var(--accent2)" id="statShell">0</div>
      <div class="stat-sub" id="subStatShell"></div>
    </div>
    <div class="stat-card" style="--accent-color: #00a0ff">
      <div class="stat-label" id="labelStatFs"></div>
      <div class="stat-value" style="color:#00a0ff" id="statFs">0</div>
      <div class="stat-sub" id="subStatFs"></div>
    </div>
    <div class="stat-card" style="--accent-color: var(--warn)">
      <div class="stat-label" id="labelStatAlerts"></div>
      <div class="stat-value" style="color:var(--warn)" id="statAlerts">0</div>
      <div class="stat-sub" id="subStatAlerts"></div>
    </div>
    <div class="stat-card" style="--accent-color: #ff9800">
      <div class="stat-label" id="labelStatWeb"></div>
      <div class="stat-value" style="color:#ff9800" id="statWeb">0</div>
      <div class="stat-sub" id="subStatWeb"></div>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="main-grid">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-dot"></div>
          <span id="titleLogs"></span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input class="log-path-input" id="logPath"
            value="/Users/ryansmacmini/.openclaw/logs/gateway.log"
            placeholder="Log file path" style="width:280px;" />
          <button class="panel-action" onclick="clearLogs()" id="btnClearLogs"></button>
          <button class="panel-action" id="autoScrollBtn" onclick="toggleAutoScroll()" style="color:var(--accent)"></button>
        </div>
      </div>
      <div class="log-stream" id="logStream">
        <div class="empty-state">
          <div class="empty-icon">üì°</div>
          <span id="emptyLogs"></span>
          <span style="color:var(--muted);font-size:10px" id="emptyLogsSub"></span>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-dot" style="background:var(--warn)"></div>
          <span id="titleAlerts"></span>
        </div>
        <button class="panel-action" onclick="clearAlerts()" id="btnClearAlerts"></button>
      </div>
      <div class="alerts-list" id="alertsList">
        <div class="empty-state">
          <div class="empty-icon">üõ°Ô∏è</div>
          <span id="emptyAlerts"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Grid -->
  <div class="bottom-grid">
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-dot" style="background:var(--accent2)"></div>
          <span id="titleTools"></span>
        </div>
        <button class="panel-action" onclick="clearTools()" id="btnClearTools"></button>
      </div>
      <div class="tool-list" id="toolList">
        <div class="empty-state">
          <div class="empty-icon">‚öôÔ∏è</div>
          <span id="emptyTools"></span>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-dot"></div>
          <span id="titleChart"></span>
        </div>
      </div>
      <div class="chart-area">
        <div class="chart-bars" id="chartBars"></div>
        <div class="chart-labels" id="chartLabels"></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-dot" style="background:#00a0ff"></div>
          <span id="titleSystem"></span>
        </div>
      </div>
      <div class="memory-display">
        <div class="config-row" style="padding-bottom:10px;border-bottom:1px solid var(--border);margin-bottom:8px;">
          <span class="config-key" id="labelCurrentModel"></span>
          <span class="config-val" id="modelDisplay" style="color:var(--accent);font-weight:600;">moonshot/kimi-k2.5</span>
        </div>

        <div class="memory-bar-wrap">
          <div class="memory-bar-header">
            <span class="memory-bar-label" id="labelTokenUsage"></span>
            <span class="memory-bar-val" id="tokenVal">-- / 256k</span>
          </div>
          <div class="memory-bar-bg">
            <div class="memory-bar-fill green" id="tokenBar" style="width:0%"></div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:8px 0;padding:8px;background:var(--surface2);border-radius:8px;border:1px solid var(--border);">
          <div style="font-size:10px;color:var(--text2);" id="labelTokenIn"></div>
          <div style="font-size:11px;color:var(--text);text-align:right;" id="tokenIn">‚Äî</div>
          <div style="font-size:10px;color:var(--text2);" id="labelTokenOut"></div>
          <div style="font-size:11px;color:var(--accent2);text-align:right;" id="tokenOut">‚Äî</div>
          <div style="font-size:10px;color:var(--text2);" id="labelCacheHit"></div>
          <div style="font-size:11px;color:#00a0ff;text-align:right;" id="tokenCache">‚Äî</div>
          <div style="font-size:10px;color:var(--text2);" id="labelTurns"></div>
          <div style="font-size:11px;color:var(--text);text-align:right;" id="turnCount">0</div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--surface2);border-radius:8px;border:1px solid rgba(0,255,136,0.15);margin-bottom:8px;">
          <span style="font-size:10px;color:var(--text2);" id="labelTotalCost"></span>
          <span style="font-size:16px;font-weight:800;color:var(--accent);font-family:var(--sans);" id="costTotal">¬•0.0000</span>
        </div>

        <div class="memory-bar-wrap">
          <div class="memory-bar-header">
            <span class="memory-bar-label" id="labelShellRate"></span>
            <span class="memory-bar-val" id="shellRateVal">0</span>
          </div>
          <div class="memory-bar-bg">
            <div class="memory-bar-fill orange" id="shellRateBar" style="width:0%"></div>
          </div>
        </div>

        <div class="config-row" style="border-top:1px solid var(--border);padding-top:10px;">
          <span class="config-key" id="labelShellThreshold"></span>
          <span class="config-val">‚â• <input id="shellThreshold" type="number" value="5" min="1" max="50"
            style="width:36px;background:var(--surface2);border:1px solid var(--border);color:var(--accent);font-family:var(--mono);font-size:11px;padding:1px 4px;border-radius:4px;text-align:center;outline:none;"> <span id="labelPerMin"></span></span>
        </div>
        <div class="config-row">
          <span class="config-key" id="labelDangerAlert"></span>
          <label class="toggle"><input type="checkbox" id="dangerAlert" checked><div class="toggle-slider"></div></label>
        </div>
        <div class="config-row">
          <span class="config-key" id="labelDeleteAlert"></span>
          <label class="toggle"><input type="checkbox" id="deleteAlert" checked><div class="toggle-slider"></div></label>
        </div>
        <div class="config-row" style="border:none">
          <span class="config-key" id="labelBrowserNotify"></span>
          <label class="toggle"><input type="checkbox" id="notifyAlert" onchange="requestNotify()"><div class="toggle-slider"></div></label>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ‚îÄ i18n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const i18n = {
  zh: {
    pageTitle:        "Ryan's Suit ‚Äî ÁõëÊéß‰∏≠Êû¢",
    subtitle:         "OpenClaw ¬∑ ÂÖ®Ê†àË∞ÉÁî®ÁõëÊéß‰∏≠Êû¢",
    btnRename:        "ÊîπÂêç",
    namePlaceholder:  "ËæìÂÖ•‰Ω†ÁöÑÂêçÂ≠ó",
    nameSave:         "‰øùÂ≠ò",
    nameCancel:       "ÂèñÊ∂à",
    labelLogService:  "Êó•ÂøóÊúçÂä°",
    btnStart:         "ÂºÄÂßãÁõëÊéß",
    btnStop:          "ÂÅúÊ≠¢",
    statusOnline:     "Â∑≤ËøûÊé•",
    statusOffline:    "Êú™ËøûÊé•",
    labelToday:       "‰ªäÊó•",
    labelMonth:       "Êú¨Êúà",
    labelInput:       "ËæìÂÖ•",
    labelOutput:      "ËæìÂá∫",
    // stats
    labelStatTotal:   "ÊÄªË∞ÉÁî®Ê¨°Êï∞",
    subStatTotal:     "Êú¨Ê¨°‰ºöËØù",
    labelStatShell:   "Shell ÂëΩ‰ª§",
    subStatShell:     "exec Ê¨°Êï∞",
    labelStatFs:      "Êñá‰ª∂Êìç‰Ωú",
    subStatFs:        "read + write",
    labelStatAlerts:  "È¢ÑË≠¶Êï∞Èáè",
    subStatAlerts:    "ÈúÄË¶ÅÂÖ≥Ê≥®",
    labelStatWeb:     "ÁΩëÁªúËØ∑Ê±Ç",
    subStatWeb:       "fetch + search",
    // panels
    titleLogs:        "ÂÆûÊó∂Êìç‰ΩúÊó•Âøó",
    btnClearLogs:     "Ê∏ÖÁ©∫",
    autoScrollOn:     "‚Üì Ë∑üÈöè",
    autoScrollOff:    "‚óã ÊöÇÂÅú",
    emptyLogs:        "ËøûÊé• Gateway ÂêéÂºÄÂßãÊé•Êî∂Êó•Âøó",
    emptyLogsSub:     "Êàñ‰ΩøÁî®ÊµèËßàÂô®Êâ©Â±ïËØªÂèñÊú¨Âú∞Êó•ÂøóÊñá‰ª∂",
    titleAlerts:      "ÂÆâÂÖ®È¢ÑË≠¶",
    btnClearAlerts:   "Ê∏ÖÁ©∫",
    emptyAlerts:      "ÊöÇÊó†È¢ÑË≠¶",
    titleTools:       "Â∑•ÂÖ∑Ë∞ÉÁî®ËÆ∞ÂΩï",
    btnClearTools:    "Ê∏ÖÁ©∫",
    emptyTools:       "Á≠âÂæÖÂ∑•ÂÖ∑Ë∞ÉÁî®",
    titleChart:       "Ë∞ÉÁî®È¢ëÁéá (ÊúÄËøë60Áßí)",
    titleSystem:      "Á≥ªÁªüÁä∂ÊÄÅ & È¢ÑË≠¶ËÆæÁΩÆ",
    // system panel
    labelCurrentModel: "ÂΩìÂâçÊ®°Âûã",
    labelTokenUsage:   "Êú¨Ê¨° Token Áî®Èáè",
    labelTokenIn:      "ËæìÂÖ• tokens",
    labelTokenOut:     "ËæìÂá∫ tokens",
    labelCacheHit:     "ÁºìÂ≠òÂëΩ‰∏≠",
    labelTurns:        "ÂØπËØùËΩÆÊ¨°",
    labelTotalCost:    "üí∞ Á¥ØËÆ°Ë¥πÁî®",
    labelShellRate:    "Shell Ë∞ÉÁî®È¢ëÁéá",
    shellRateUnit:     "Ê¨°/ÂàÜ",
    labelShellThreshold: "Shell ÊâßË°åÈ¢ÑË≠¶ÈòàÂÄº",
    labelPerMin:       "Ê¨°/ÂàÜ",
    labelDangerAlert:  "Âç±Èô©ÂëΩ‰ª§È¢ÑË≠¶",
    labelDeleteAlert:  "Êñá‰ª∂Âà†Èô§È¢ÑË≠¶",
    labelBrowserNotify:"ÊµèËßàÂô®ÈÄöÁü•",
    // alert labels
    alertCritical:    "üî¥ ‰∏•Èáç",
    alertWarning:     "üü† Ë≠¶Âëä",
    alertInfo:        "üü¢ ‰ø°ÊÅØ",
    // log messages (system generated)
    sysStarted:       "Êó•ÂøóÁõëÊéßÂ∑≤ÂêØÂä® ‚Äî ËØªÂèñÂØπËØù & gateway Êó•Âøó",
    sysStopped:       "ÁõëÊéßÂ∑≤ÂÅúÊ≠¢",
    sysDisconnected:  "Êó•ÂøóÊúçÂä°Êñ≠ÂºÄ",
  },
  en: {
    pageTitle:        "Ryan's Suit ‚Äî Monitor Hub",
    subtitle:         "OpenClaw ¬∑ Full-stack Agent Monitor",
    btnRename:        "Rename",
    namePlaceholder:  "Enter your name",
    nameSave:         "Save",
    nameCancel:       "Cancel",
    labelLogService:  "Log Service",
    btnStart:         "Start Monitor",
    btnStop:          "Stop",
    statusOnline:     "Connected",
    statusOffline:    "Disconnected",
    labelToday:       "Today",
    labelMonth:       "Month",
    labelInput:       "Input",
    labelOutput:      "Output",
    // stats
    labelStatTotal:   "Total Calls",
    subStatTotal:     "this session",
    labelStatShell:   "Shell Cmds",
    subStatShell:     "exec count",
    labelStatFs:      "File Ops",
    subStatFs:        "read + write",
    labelStatAlerts:  "Alerts",
    subStatAlerts:    "needs attention",
    labelStatWeb:     "Network Reqs",
    subStatWeb:       "fetch + search",
    // panels
    titleLogs:        "Live Operation Log",
    btnClearLogs:     "Clear",
    autoScrollOn:     "‚Üì Follow",
    autoScrollOff:    "‚óã Pause",
    emptyLogs:        "Connect to Gateway to start receiving logs",
    emptyLogsSub:     "Or use browser extension to read local log file",
    titleAlerts:      "Security Alerts",
    btnClearAlerts:   "Clear",
    emptyAlerts:      "No alerts",
    titleTools:       "Tool Call History",
    btnClearTools:    "Clear",
    emptyTools:       "Waiting for tool calls",
    titleChart:       "Call Rate (last 60s)",
    titleSystem:      "System Status & Alert Config",
    // system panel
    labelCurrentModel: "Current Model",
    labelTokenUsage:   "Token Usage (session)",
    labelTokenIn:      "Input tokens",
    labelTokenOut:     "Output tokens",
    labelCacheHit:     "Cache hits",
    labelTurns:        "Conv. turns",
    labelTotalCost:    "üí∞ Total Cost",
    labelShellRate:    "Shell Call Rate",
    shellRateUnit:     "calls/min",
    labelShellThreshold: "Shell Alert Threshold",
    labelPerMin:       "calls/min",
    labelDangerAlert:  "Dangerous Cmd Alert",
    labelDeleteAlert:  "File Delete Alert",
    labelBrowserNotify:"Browser Notifications",
    // alert labels
    alertCritical:    "üî¥ Critical",
    alertWarning:     "üü† Warning",
    alertInfo:        "üü¢ Info",
    // log messages
    sysStarted:       "Log monitoring started ‚Äî reading conversation & gateway logs",
    sysStopped:       "Monitoring stopped",
    sysDisconnected:  "Log service disconnected",
  }
};

let currentLang = localStorage.getItem('lang') || 'zh';

function t(key) {
  return i18n[currentLang][key] || i18n.zh[key] || key;
}

function applyLang() {
  const lang = currentLang;
  document.documentElement.lang = lang;
  document.title = t('pageTitle');

  // Lang toggle button
  document.getElementById('langZh').className = lang === 'zh' ? 'lang-active' : '';
  document.getElementById('langEn').className  = lang === 'en' ? 'lang-active' : '';

  // Header
  document.getElementById('suitSubtitle').textContent   = t('subtitle');
  document.getElementById('btnRename').textContent       = t('btnRename');
  document.getElementById('nameSaveBtn').textContent     = t('nameSave');
  document.getElementById('nameCancelBtn').textContent   = t('nameCancel');
  document.getElementById('nameEditInput').placeholder   = t('namePlaceholder');
  document.getElementById('labelLogService').textContent = t('labelLogService');
  document.getElementById('btnStart').textContent        = t('btnStart');
  document.getElementById('btnStop').textContent         = t('btnStop');
  document.getElementById('statusText').textContent      = state.connected ? t('statusOnline') : t('statusOffline');

  // Spending bar
  document.getElementById('labelToday').textContent  = t('labelToday');
  document.getElementById('labelMonth').textContent  = t('labelMonth');
  document.getElementById('labelInput').textContent  = t('labelInput');
  document.getElementById('labelOutput').textContent = t('labelOutput');

  // Stats cards
  document.getElementById('labelStatTotal').textContent  = t('labelStatTotal');
  document.getElementById('subStatTotal').textContent    = t('subStatTotal');
  document.getElementById('labelStatShell').textContent  = t('labelStatShell');
  document.getElementById('subStatShell').textContent    = t('subStatShell');
  document.getElementById('labelStatFs').textContent     = t('labelStatFs');
  document.getElementById('subStatFs').textContent       = t('subStatFs');
  document.getElementById('labelStatAlerts').textContent = t('labelStatAlerts');
  document.getElementById('subStatAlerts').textContent   = t('subStatAlerts');
  document.getElementById('labelStatWeb').textContent    = t('labelStatWeb');
  document.getElementById('subStatWeb').textContent      = t('subStatWeb');

  // Panel titles & buttons
  document.getElementById('titleLogs').textContent        = t('titleLogs');
  document.getElementById('btnClearLogs').textContent     = t('btnClearLogs');
  document.getElementById('titleAlerts').textContent      = t('titleAlerts');
  document.getElementById('btnClearAlerts').textContent   = t('btnClearAlerts');
  document.getElementById('titleTools').textContent       = t('titleTools');
  document.getElementById('btnClearTools').textContent    = t('btnClearTools');
  document.getElementById('titleChart').textContent       = t('titleChart');
  document.getElementById('titleSystem').textContent      = t('titleSystem');

  // Auto-scroll button
  const asBtn = document.getElementById('autoScrollBtn');
  asBtn.textContent = state.autoScroll ? t('autoScrollOn') : t('autoScrollOff');

  // System panel
  document.getElementById('labelCurrentModel').textContent  = t('labelCurrentModel');
  document.getElementById('labelTokenUsage').textContent    = t('labelTokenUsage');
  document.getElementById('labelTokenIn').textContent       = t('labelTokenIn');
  document.getElementById('labelTokenOut').textContent      = t('labelTokenOut');
  document.getElementById('labelCacheHit').textContent      = t('labelCacheHit');
  document.getElementById('labelTurns').textContent         = t('labelTurns');
  document.getElementById('labelTotalCost').textContent     = t('labelTotalCost');
  document.getElementById('labelShellRate').textContent     = t('labelShellRate');
  document.getElementById('labelShellThreshold').textContent= t('labelShellThreshold');
  document.getElementById('labelPerMin').textContent        = t('labelPerMin');
  document.getElementById('labelDangerAlert').textContent   = t('labelDangerAlert');
  document.getElementById('labelDeleteAlert').textContent   = t('labelDeleteAlert');
  document.getElementById('labelBrowserNotify').textContent = t('labelBrowserNotify');

  // Shell rate value
  document.getElementById('shellRateVal').textContent = state.shellPerMin + ' ' + t('shellRateUnit');

  // Empty states (only update if still showing empty state)
  const logEmpty  = document.querySelector('#logStream .empty-state span:first-of-type');
  const logEmptySub = document.querySelector('#logStream .empty-state span:last-of-type');
  if (logEmpty)    logEmpty.textContent    = t('emptyLogs');
  if (logEmptySub) logEmptySub.textContent = t('emptyLogsSub');

  const alertEmpty = document.querySelector('#alertsList .empty-state span');
  if (alertEmpty) alertEmpty.textContent = t('emptyAlerts');

  const toolEmpty = document.querySelector('#toolList .empty-state span');
  if (toolEmpty) toolEmpty.textContent = t('emptyTools');
}

function toggleLang() {
  currentLang = currentLang === 'zh' ? 'en' : 'zh';
  localStorage.setItem('lang', currentLang);
  applyLang();
}

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const state = {
  ws: null,
  connected: false,
  autoScroll: true,
  stats: { total: 0, shell: 0, fs: 0, alerts: 0, web: 0 },
  activity: new Array(20).fill(0),
  activityLabels: [],
  shellPerMin: 0,
  shellCountWindow: [],
  tokenTotal: { input: 0, output: 0, cacheRead: 0, total: 0 },
  costTotal: 0,
  currentModel: 'moonshot/kimi-k2.5',
  turnCount: 0,
};

// ‚îÄ‚îÄ‚îÄ Clock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
setInterval(() => {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString('zh-CN', { hour12: false });
}, 1000);

// ‚îÄ‚îÄ‚îÄ Init chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initChart() {
  const bars = document.getElementById('chartBars');
  const labels = document.getElementById('chartLabels');
  bars.innerHTML = '';
  labels.innerHTML = '';
  for (let i = 0; i < 20; i++) {
    const wrap = document.createElement('div');
    wrap.className = 'chart-bar-wrap';
    const bar = document.createElement('div');
    bar.className = 'chart-bar normal';
    bar.style.height = '2px';
    bar.setAttribute('data-val', '0');
    wrap.appendChild(bar);
    bars.appendChild(wrap);
    const lbl = document.createElement('div');
    lbl.className = 'chart-label';
    lbl.textContent = i % 5 === 0 ? `-${(19-i)*3}s` : '';
    labels.appendChild(lbl);
  }
}
initChart();

function updateChart() {
  const bars = document.querySelectorAll('.chart-bar');
  const max = Math.max(...state.activity, 1);
  bars.forEach((bar, i) => {
    const val = state.activity[i] || 0;
    const pct = (val / max) * 140;
    bar.style.height = Math.max(2, pct) + 'px';
    bar.setAttribute('data-val', val);
    bar.className = 'chart-bar ' + (val > 8 ? 'peak' : val > 4 ? 'high' : 'normal');
  });
}

setInterval(() => {
  state.activity.shift();
  state.activity.push(0);
  updateChart();

  const now = Date.now();
  state.shellCountWindow = state.shellCountWindow.filter(t => now - t < 60000);
  state.shellPerMin = state.shellCountWindow.length;
  document.getElementById('shellRateVal').textContent = state.shellPerMin + ' ' + t('shellRateUnit');
  const shellPct = Math.min(100, (state.shellPerMin / 20) * 100);
  document.getElementById('shellRateBar').style.width = shellPct + '%';

  const threshold = parseInt(document.getElementById('shellThreshold').value) || 5;
  if (state.shellPerMin >= threshold) {
    const msg = currentLang === 'zh'
      ? `ËøáÂéª1ÂàÜÈíüÊâßË°å‰∫Ü ${state.shellPerMin} Ê¨° shell ÂëΩ‰ª§`
      : `${state.shellPerMin} shell commands in the last minute`;
    addAlert('warning',
      currentLang === 'zh' ? 'Shell Ë∞ÉÁî®È¢ëÁéáËøáÈ´ò' : 'High Shell Call Rate',
      msg);
  }
}, 3000);

// ‚îÄ‚îÄ‚îÄ Polling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pollingTimer = null;
let sessionTimer = null;
let lastLogLines = new Set();
let lastLineCount = 0;
let lastSessionMsgId = null;

function connectGateway() { startPolling(); }

function startPolling() {
  const origin = window.location.origin.startsWith('http') && !window.location.protocol.startsWith('file')
    ? window.location.origin : 'http://127.0.0.1:19999';
  const inputVal = document.getElementById('logApiUrl')?.value.trim() || '';
  const apiBase = (inputVal || origin).replace(/\/logs$/, '').replace(/\/$/, '');

  if (pollingTimer) clearInterval(pollingTimer);
  if (sessionTimer) clearInterval(sessionTimer);
  lastLogLines.clear();
  lastLineCount = -1;
  lastSessionMsgId = null;
  state.connected = true;
  setStatus(true);
  addLog('info', 'system', 'SYS', t('sysStarted'));

  fetch(apiBase + '/config').then(r => r.json()).then(cfg => {
    const name = cfg.agentName || cfg.systemUser || 'My Suit';
    document.querySelector('.logo-text h1').textContent = name + ' Monitor';
    document.title = name + ' Monitor';
    if (cfg.model) updateModel(cfg.model);
    addLog('info', 'system', 'CFG', `Agent: ${name} | Model: ${cfg.model || '‚Äî'}`);
  }).catch(() => {});

  fetchLogs(apiBase + '/logs', true);
  fetchSession(apiBase + '/session', true);
  loadConfig(apiBase);
  pollingTimer = setInterval(() => fetchLogs(apiBase + '/logs', false), 3000);
  sessionTimer = setInterval(() => fetchSession(apiBase + '/session', false), 2000);
}

function stopPolling() {
  if (pollingTimer) { clearInterval(pollingTimer); pollingTimer = null; }
  if (sessionTimer) { clearInterval(sessionTimer); sessionTimer = null; }
  state.connected = false;
  setStatus(false);
  addLog('info', 'system', 'SYS', t('sysStopped'));
}

async function fetchLogs(url, isInit) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    const lines = text.trim().split('\n').filter(l => l.trim());
    if (isInit) {
      lines.forEach(l => lastLogLines.add(l));
      lastLineCount = lines.length;
    } else {
      if (lines.length > lastLineCount) {
        lines.slice(lastLineCount).forEach(line => {
          if (!lastLogLines.has(line)) {
            lastLogLines.add(line);
            parseLogLine(line);
          }
        });
        lastLineCount = lines.length;
      }
    }
  } catch(e) {
    if (state.connected) {
      stopPolling();
      addLog('error', 'system', 'ERR', t('sysDisconnected') + ': ' + e.message);
      addAlert('critical',
        currentLang === 'zh' ? 'Êó•ÂøóÊúçÂä°Êñ≠ÂºÄ' : 'Log Service Disconnected',
        currentLang === 'zh' ? 'ËØ∑Á°ÆËÆ§ log-server.py Ê≠£Âú®ËøêË°å' : 'Please ensure log-server.py is running');
    }
  }
}

async function loadConfig(base) {
  try {
    const res = await fetch(base + '/config');
    if (!res.ok) return;
    const cfg = await res.json();
    if (cfg.agentName) applyName(cfg.agentName);
  } catch(e) {}
}

function applyName(name) {
  document.title = currentLang === 'zh' ? `${name}'s Suit ‚Äî ÁõëÊéß‰∏≠Êû¢` : `${name}'s Suit ‚Äî Monitor Hub`;
  const h1 = document.getElementById('suitTitle');
  if (h1) h1.textContent = `${name}'s Suit Monitor`;
  const sub = document.getElementById('suitSubtitle');
  if (sub) sub.textContent = t('subtitle').replace('OpenClaw', `OpenClaw ¬∑ ${name}`);
}

function editName() {
  const wrap = document.getElementById('nameEditWrap');
  const btn = document.getElementById('nameEditBtn');
  const input = document.getElementById('nameEditInput');
  const current = document.getElementById('suitTitle')?.textContent.replace("'s Suit Monitor", '') || '';
  input.value = current;
  wrap.style.display = 'flex';
  btn.style.display = 'none';
  input.focus();
  input.select();
}

function cancelEditName() {
  document.getElementById('nameEditWrap').style.display = 'none';
  document.getElementById('nameEditBtn').style.display = '';
}

async function saveName() {
  const name = document.getElementById('nameEditInput').value.trim();
  if (!name) return;
  try {
    const base = window.location.origin.startsWith('http') && !window.location.protocol.startsWith('file')
      ? window.location.origin : 'http://127.0.0.1:19999';
    await fetch(base + '/name', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    applyName(name);
    cancelEditName();
    addLog('info', 'system', 'SYS',
      currentLang === 'zh' ? `ÂêçÂ≠óÂ∑≤Êõ¥Êñ∞‰∏∫: ${name}` : `Name updated to: ${name}`);
  } catch(e) {
    addLog('error', 'system', 'ERR',
      (currentLang === 'zh' ? '‰øùÂ≠òÂêçÂ≠óÂ§±Ë¥•: ' : 'Failed to save name: ') + e.message);
  }
}

async function fetchSession(url, isInit) {
  try {
    const res = await fetch(url);
    if (!res.ok) return;
    const msgs = await res.json();
    if (!msgs.length) return;
    if (isInit) {
      lastSessionMsgId = msgs[msgs.length - 1]?.id || null;
      const recent = msgs.slice(-5);
      recent.forEach(m => parseSessionMsg(m, false));
      return;
    }
    const lastIdx = lastSessionMsgId ? msgs.findIndex(m => m.id === lastSessionMsgId) : -1;
    const newMsgs = lastIdx >= 0 ? msgs.slice(lastIdx + 1) : [];
    newMsgs.forEach(m => parseSessionMsg(m, true));
    if (newMsgs.length > 0) lastSessionMsgId = msgs[msgs.length - 1].id;
  } catch(e) {}
}

function parseSessionMsg(msg, isNew) {
  if (!msg?.message) return;
  const role = msg.message.role;
  const content = msg.message.content || [];

  if (role === 'assistant') {
    content.forEach(block => {
      if (block.type === 'toolCall') {
        const name = block.name || 'unknown';
        const args = block.arguments || {};
        handleToolCall(name, args, null);
        if (isNew) addLog('info', 'agent', 'TOOL',
          (currentLang === 'zh' ? 'Ë∞ÉÁî®Â∑•ÂÖ∑: ' : 'Tool call: ') + name);
      } else if (block.type === 'text' && isNew) {
        const preview = block.text?.slice(0, 60) || '';
        addLog('info', 'agent', 'TURN',
          (currentLang === 'zh' ? 'Agent ÂõûÂ§ç: ' : 'Agent reply: ') + preview + '...');
      }
    });
    const usage = msg.message.usage;
    if (usage?.totalTokens) {
      updateTokenDetail(usage);
      if (isNew) {
        const cost = usage.cost?.total ? `¬•${usage.cost.total.toFixed(4)}` : (currentLang === 'zh' ? 'ÂÖçË¥π' : 'free');
        addLog('info', 'agent', 'TOK',
          `tokens: ${usage.totalTokens.toLocaleString()} (in:${usage.input} out:${usage.output} cache:${usage.cacheRead||0}) ${cost}`);
      }
    }
    if (msg.message.model) updateModel(msg.message.model);
  } else if (role === 'user' && isNew) {
    const textBlock = content.find(b => b.type === 'text');
    if (textBlock) {
      const text = textBlock.text || '';
      const clean = text.replace(/Conversation info[\s\S]*?```\s*/g, '').trim().slice(0, 60);
      if (clean) addLog('info', 'user', 'MSG',
        (currentLang === 'zh' ? 'üì± Áî®Êà∑: ' : 'üì± User: ') + clean);
    }
  } else if (role === 'toolResult' && isNew) {
    const name = msg.message.toolName || '';
    const ok = !msg.details?.isError;
    addLog(ok ? 'info' : 'error', 'tool', ok ? 'OK' : 'ERR',
      (currentLang === 'zh' ? 'Â∑•ÂÖ∑ÁªìÊûú: ' : 'Tool result: ') + name + ' ' + (ok ? '‚úì' : '‚úó'));
  }
}

function parseLogLine(line) {
  if (!line.trim()) return;
  if (line.includes('[gateway] tavily:')) {
    const q = line.match(/tavily: "(.+?)"/)?.[1] || '';
    const results = line.match(/‚Üí (\d+) results/)?.[1] || '?';
    const ms = line.match(/in (\d+)ms/)?.[1] || '?';
    state.stats.web++; state.stats.total++;
    state.activity[state.activity.length-1]++;
    addLog('info', 'web', 'NET', `tavily: "${q.slice(0,50)}" ‚Üí ${results} ${currentLang === 'zh' ? 'Êù°' : 'results'} (${ms}ms)`);
    addToolItem('üåê', 'web', 'tavily.search', {query: q}, {results});
    updateStats(); updateChart(); return;
  }
  if (line.includes('[ws] webchat connected')) {
    addLog('info', 'gateway', 'SYS', currentLang === 'zh' ? 'OpenClaw Webchat Â∑≤ËøûÊé•' : 'OpenClaw Webchat connected'); return;
  }
  if (line.includes('[ws] webchat disconnected')) {
    const code = line.match(/code=(\d+)/)?.[1] || '?';
    const reason = line.match(/reason=([^\s]+)/)?.[1] || '?';
    addLog('warn', 'gateway', 'SYS',
      currentLang === 'zh' ? `Webchat Êñ≠ÂºÄ code=${code} reason=${reason}` : `Webchat disconnected code=${code} reason=${reason}`); return;
  }
  if (line.includes('[ws] ‚áÑ res ‚úì')) {
    const method = line.match(/res ‚úì ([\w.]+)/)?.[1] || '';
    const ms = line.match(/‚úì [\w.]+ (\d+)ms/)?.[1] || '?';
    addLog('info', 'gateway', 'API', `‚úì ${method} (${ms}ms)`);
    state.stats.total++; updateStats(); return;
  }
  if (line.includes('[ws] ‚áÑ res ‚úó')) {
    const method = line.match(/res ‚úó ([\w.]+)/)?.[1] || '';
    const err = line.match(/errorMessage=(.+?)(?= conn=|$)/)?.[1] || '';
    addLog('error', 'gateway', 'ERR', `‚úó ${method}: ${err.slice(0,80)}`);
    addAlert('warning', `API ${currentLang === 'zh' ? 'ÈîôËØØ' : 'Error'}: ${method}`, err.slice(0,100)); return;
  }
  if (line.includes('[reload]')) { addLog('info', 'system', 'CFG', currentLang === 'zh' ? 'ÈÖçÁΩÆÂ∑≤ÈáçËΩΩ' : 'Config reloaded'); return; }
  if (line.includes('[plugins]')) {
    const msg = line.replace(/^.*?\[plugins\]\s*/, '').slice(0,100);
    addLog('info', 'plugins', 'PLG', msg); return;
  }
  if (line.includes('[gateway]')) {
    const msg = line.replace(/^.*?\[gateway\]\s*/, '').slice(0,100);
    addLog('info', 'gateway', 'GW', msg); return;
  }
  if (line.includes('typing TTL')) return;
  const msg = line.slice(0,120);
  if (msg.trim()) addLog('info', 'system', 'LOG', msg);
}

function handleToolCall(tool, args, result) {
  state.stats.total++;
  state.activity[state.activity.length - 1]++;

  const toolLower = tool.toLowerCase();
  let icon = '‚öôÔ∏è';
  let cls = '';

  if (toolLower.includes('shell') || toolLower.includes('exec') || toolLower.includes('bash')) {
    icon = 'üíª'; cls = 'shell';
    state.stats.shell++;
    state.shellCountWindow.push(Date.now());
    const cmd = args.command || args.cmd || JSON.stringify(args);
    if (document.getElementById('dangerAlert').checked) {
      const dangerous = ['rm -rf', 'sudo rm', '> /dev/', 'format', 'mkfs', 'dd if=', ':(){'];
      if (dangerous.some(d => cmd.includes(d))) {
        addAlert('critical',
          currentLang === 'zh' ? '‚ö†Ô∏è Âç±Èô©ÂëΩ‰ª§Ê£ÄÊµã' : '‚ö†Ô∏è Dangerous Command Detected',
          (currentLang === 'zh' ? 'ÊâßË°å‰∫ÜÈ´òÂç±ÂëΩ‰ª§: ' : 'Dangerous command executed: ') + cmd.slice(0, 80));
      }
    }
    addLog('tool', 'shell', 'EXEC', `<span class="cmd">${(args.command || args.cmd || JSON.stringify(args)).slice(0, 80)}</span>`);
  } else if (toolLower.includes('file') || toolLower.includes('fs') || toolLower.includes('read') || toolLower.includes('write')) {
    icon = 'üìÅ'; cls = 'fs';
    state.stats.fs++;
    const path = args.path || args.file || '';
    if (document.getElementById('deleteAlert').checked && (toolLower.includes('delete') || toolLower.includes('remove'))) {
      addAlert('warning',
        currentLang === 'zh' ? 'Êñá‰ª∂Âà†Èô§Êìç‰Ωú' : 'File Delete Operation',
        (currentLang === 'zh' ? 'Ê≠£Âú®Âà†Èô§: ' : 'Deleting: ') + `<span class="path">${path}</span>`);
    }
    addLog('tool', 'fs', 'FILE', `<span class="path">${path}</span> [${tool}]`);
  } else if (toolLower.includes('web') || toolLower.includes('fetch') || toolLower.includes('search') || toolLower.includes('http')) {
    icon = 'üåê'; cls = 'web';
    state.stats.web++;
    addLog('info', 'web', 'NET', `${tool} ‚Üí ${args.url || args.query || ''}`.slice(0, 80));
  } else if (toolLower.includes('memory') || toolLower.includes('recall')) {
    icon = 'üß†'; cls = 'memory';
    addLog('info', 'memory', 'MEM', `${tool}: ${JSON.stringify(args).slice(0, 60)}`);
  } else if (toolLower.includes('message') || toolLower.includes('telegram') || toolLower.includes('send')) {
    icon = 'üí¨'; cls = 'msg';
    addLog('info', 'msg', 'MSG',
      (currentLang === 'zh' ? 'ÂèëÈÄÅÊ∂àÊÅØ: ' : 'Send message: ') + JSON.stringify(args).slice(0, 60));
  } else {
    addLog('info', 'tool', 'TOOL', `${tool}: ${JSON.stringify(args).slice(0, 70)}`);
  }

  updateStats();
  updateChart();
  addToolItem(icon, cls, tool, args, result);
}

// ‚îÄ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(online) {
  const badge = document.getElementById('statusBadge');
  badge.className = 'status-badge ' + (online ? 'online' : 'offline');
  document.getElementById('statusText').textContent = online ? t('statusOnline') : t('statusOffline');
}

function updateStats() {
  document.getElementById('statTotal').textContent  = state.stats.total;
  document.getElementById('statShell').textContent  = state.stats.shell;
  document.getElementById('statFs').textContent     = state.stats.fs;
  document.getElementById('statAlerts').textContent = state.stats.alerts;
  document.getElementById('statWeb').textContent    = state.stats.web;
}

function updateTokens(used, max) {
  const pct = Math.min(100, (used / max) * 100);
  document.getElementById('tokenVal').textContent = `${used.toLocaleString()} / ${(max/1000).toFixed(0)}k`;
  document.getElementById('tokenBar').style.width = pct + '%';
  document.getElementById('tokenBar').className = 'memory-bar-fill ' + (pct > 80 ? 'orange' : 'green');
}

function updateTokenDetail(usage) {
  if (!usage) return;
  state.tokenTotal.input     += usage.input || 0;
  state.tokenTotal.output    += usage.output || 0;
  state.tokenTotal.cacheRead += usage.cacheRead || 0;
  state.tokenTotal.total     += usage.totalTokens || 0;
  state.turnCount++;
  updateTokens(usage.totalTokens || 0, 256000);
  document.getElementById('tokenIn').textContent    = state.tokenTotal.input.toLocaleString();
  document.getElementById('tokenOut').textContent   = state.tokenTotal.output.toLocaleString();
  document.getElementById('tokenCache').textContent = state.tokenTotal.cacheRead.toLocaleString();
  document.getElementById('turnCount').textContent  = state.turnCount;
  document.getElementById('headerTokenTotal').textContent = state.tokenTotal.total.toLocaleString();
  document.getElementById('headerTokenIn').textContent    = state.tokenTotal.input.toLocaleString();
  document.getElementById('headerTokenOut').textContent   = state.tokenTotal.output.toLocaleString();
  if (usage.cost?.total != null) state.costTotal += usage.cost.total;
  const fmt = (n) => n === 0 ? '$0.00' : `¬•${n.toFixed(4)}`;
  const fmtFree = (n) => n === 0 ? `¬•0.0000 (${currentLang === 'zh' ? 'ÂÖçË¥πÈ¢ùÂ∫¶' : 'Free tier'})` : fmt(n);
  const color = state.costTotal > 10 ? 'var(--warn)' : 'var(--accent)';
  const headerCost = document.getElementById('headerCostTotal');
  headerCost.textContent = fmt(state.costTotal);
  headerCost.style.color = color;
  document.getElementById('headerCostDay').textContent   = fmt(state.costTotal);
  document.getElementById('headerCostMonth').textContent = fmt(state.costTotal);
  const costEl = document.getElementById('costTotal');
  if (costEl) { costEl.textContent = fmtFree(state.costTotal); costEl.style.color = color; }
}

function updateModel(model) {
  if (!model || model === state.currentModel) return;
  state.currentModel = model;
  const el = document.getElementById('modelDisplay');
  if (el) el.textContent = model;
  const hel = document.getElementById('headerModel');
  if (hel) hel.textContent = model.replace('moonshot/', '').replace('openai/', '');
}

function addLog(level, source, tag, msg) {
  const stream = document.getElementById('logStream');
  const empty = stream.querySelector('.empty-state');
  if (empty) empty.remove();
  const tStr = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const el = document.createElement('div');
  el.className = `log-entry ${level}`;
  el.innerHTML = `
    <span class="log-time">${tStr}</span>
    <span class="log-level">${tag}</span>
    <span class="log-source">${source}</span>
    <span class="log-msg">${msg}</span>
  `;
  stream.appendChild(el);
  while (stream.children.length > 200) stream.removeChild(stream.firstChild);
  if (state.autoScroll) stream.scrollTop = stream.scrollHeight;
}

function addAlert(level, title, detail) {
  const list = document.getElementById('alertsList');
  const empty = list.querySelector('.empty-state');
  if (empty) empty.remove();
  state.stats.alerts++;
  updateStats();
  const tStr = new Date().toLocaleTimeString('zh-CN', { hour12: false });
  const el = document.createElement('div');
  el.className = `alert-item ${level}`;
  const levelLabel = level === 'critical' ? t('alertCritical') : level === 'warning' ? t('alertWarning') : t('alertInfo');
  el.innerHTML = `
    <div class="alert-header">
      <span class="alert-type">${levelLabel}</span>
      <span class="alert-time">${tStr}</span>
    </div>
    <div class="alert-msg">${title}</div>
    <div class="alert-detail">${detail}</div>
  `;
  el.onclick = () => el.remove();
  list.insertBefore(el, list.firstChild);
  if (document.getElementById('notifyAlert').checked && level === 'critical') {
    new Notification("Ryan's Suit " + t('alertCritical'), { body: title + '\n' + detail, icon: 'ü¶û' });
  }
  while (list.children.length > 50) list.removeChild(list.lastChild);
}

function addToolItem(icon, cls, name, args, result) {
  const list = document.getElementById('toolList');
  const empty = list.querySelector('.empty-state');
  if (empty) empty.remove();
  const argStr = JSON.stringify(args).replace(/[{}"]/g, '').slice(0, 50);
  const status = result?.error ? 'err' : result ? 'ok' : 'running';
  const statusLabel = status === 'err' ? 'ERR' : status === 'ok' ? 'OK' : '...';
  const el = document.createElement('div');
  el.className = 'tool-item';
  el.innerHTML = `
    <div class="tool-icon ${cls}">${icon}</div>
    <div class="tool-info">
      <div class="tool-name">${name}</div>
      <div class="tool-args">${argStr}</div>
    </div>
    <span class="tool-status ${status}">${statusLabel}</span>
  `;
  list.insertBefore(el, list.firstChild);
  while (list.children.length > 50) list.removeChild(list.lastChild);
}

function clearLogs() {
  const stream = document.getElementById('logStream');
  stream.innerHTML = `<div class="empty-state"><div class="empty-icon">üì°</div><span>${t('emptyLogs')}</span><span style="color:var(--muted);font-size:10px">${t('emptyLogsSub')}</span></div>`;
}

function clearAlerts() {
  state.stats.alerts = 0;
  updateStats();
  document.getElementById('alertsList').innerHTML = `<div class="empty-state"><div class="empty-icon">üõ°Ô∏è</div><span>${t('emptyAlerts')}</span></div>`;
}

function clearTools() {
  document.getElementById('toolList').innerHTML = `<div class="empty-state"><div class="empty-icon">‚öôÔ∏è</div><span>${t('emptyTools')}</span></div>`;
}

function toggleAutoScroll() {
  state.autoScroll = !state.autoScroll;
  const btn = document.getElementById('autoScrollBtn');
  btn.style.color = state.autoScroll ? 'var(--accent)' : 'var(--muted)';
  btn.textContent = state.autoScroll ? t('autoScrollOn') : t('autoScrollOff');
}

function requestNotify() {
  if (document.getElementById('notifyAlert').checked) Notification.requestPermission();
}

// ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
applyLang();
setTimeout(startPolling, 500);
</script>
</body>
</html>
