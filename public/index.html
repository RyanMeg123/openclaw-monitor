<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ryan's Suit â€” ç›‘æ§ä¸­æ¢</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;700;800&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #0f0f1a;
    --surface2: #141420;
    --border: #1e1e35;
    --accent: #00ff88;
    --accent2: #7c3aff;
    --warn: #ff6b35;
    --danger: #ff2d55;
    --muted: #3a3a5c;
    --text: #e8e8f0;
    --text2: #7878a0;
    --mono: 'JetBrains Mono', monospace;
    --sans: 'Syne', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 24px;
  }

  /* Header */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    animation: pulse-glow 3s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 20px rgba(0,255,136,0.3); }
    50% { box-shadow: 0 0 40px rgba(0,255,136,0.6), 0 0 80px rgba(0,255,136,0.2); }
  }

  .logo-text h1 {
    font-family: var(--sans);
    font-size: 18px;
    font-weight: 800;
    letter-spacing: -0.5px;
  }

  .logo-text span {
    font-size: 11px;
    color: var(--text2);
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .status-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid;
    transition: all 0.3s;
  }

  .status-badge.online {
    color: var(--accent);
    border-color: rgba(0,255,136,0.3);
    background: rgba(0,255,136,0.05);
  }

  .status-badge.offline {
    color: var(--danger);
    border-color: rgba(255,45,85,0.3);
    background: rgba(255,45,85,0.05);
  }

  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: currentColor;
  }

  .status-badge.online .status-dot {
    animation: blink 1.5s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .time-display {
    font-size: 12px;
    color: var(--text2);
    letter-spacing: 1px;
  }

  /* Stats row */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent-color, var(--accent)), transparent);
    opacity: 0.6;
  }

  .stat-card:hover { border-color: var(--muted); }

  .stat-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text2);
    margin-bottom: 8px;
  }

  .stat-value {
    font-family: var(--sans);
    font-size: 28px;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-sub {
    font-size: 10px;
    color: var(--text2);
  }

  /* Main grid */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 20px;
    margin-bottom: 20px;
  }

  /* Panel */
  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
  }

  .panel-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--text2);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .panel-title-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--accent);
  }

  .panel-action {
    font-size: 10px;
    color: var(--text2);
    cursor: pointer;
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    transition: all 0.2s;
    background: none;
    font-family: var(--mono);
  }

  .panel-action:hover {
    color: var(--accent);
    border-color: rgba(0,255,136,0.3);
    background: rgba(0,255,136,0.05);
  }

  /* Log stream */
  .log-stream {
    padding: 12px;
    height: 420px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
    scroll-behavior: smooth;
  }

  .log-stream::-webkit-scrollbar { width: 4px; }
  .log-stream::-webkit-scrollbar-track { background: transparent; }
  .log-stream::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 2px; }

  .log-entry {
    display: grid;
    grid-template-columns: 60px 55px 80px 1fr;
    gap: 8px;
    padding: 6px 8px;
    border-radius: 6px;
    font-size: 11px;
    line-height: 1.5;
    border: 1px solid transparent;
    transition: all 0.2s;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .log-entry:hover {
    background: var(--surface2);
    border-color: var(--border);
  }

  .log-entry.info .log-level { color: var(--accent); }
  .log-entry.warn { background: rgba(255,107,53,0.04); }
  .log-entry.warn .log-level { color: var(--warn); }
  .log-entry.error { background: rgba(255,45,85,0.06); border-color: rgba(255,45,85,0.15); }
  .log-entry.error .log-level { color: var(--danger); }
  .log-entry.tool { background: rgba(124,58,255,0.05); }
  .log-entry.tool .log-level { color: var(--accent2); }

  .log-time { color: var(--muted); font-size: 10px; }
  .log-level { font-weight: 700; font-size: 10px; text-transform: uppercase; }
  .log-source { color: var(--text2); font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .log-msg { color: var(--text); word-break: break-word; }
  .log-msg .highlight { color: var(--accent); font-weight: 500; }
  .log-msg .path { color: var(--accent2); }
  .log-msg .cmd { color: var(--warn); font-family: var(--mono); background: rgba(255,107,53,0.1); padding: 1px 4px; border-radius: 3px; }

  /* Alerts panel */
  .alerts-list {
    padding: 10px;
    height: 420px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .alert-item {
    padding: 12px;
    border-radius: 10px;
    border: 1px solid;
    animation: fadeIn 0.3s ease;
    cursor: pointer;
    transition: all 0.2s;
  }

  .alert-item:hover { transform: translateX(3px); }

  .alert-item.critical {
    border-color: rgba(255,45,85,0.3);
    background: rgba(255,45,85,0.06);
  }

  .alert-item.warning {
    border-color: rgba(255,107,53,0.3);
    background: rgba(255,107,53,0.06);
  }

  .alert-item.info {
    border-color: rgba(0,255,136,0.2);
    background: rgba(0,255,136,0.04);
  }

  .alert-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }

  .alert-type {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-weight: 700;
  }

  .alert-item.critical .alert-type { color: var(--danger); }
  .alert-item.warning .alert-type { color: var(--warn); }
  .alert-item.info .alert-type { color: var(--accent); }

  .alert-time { font-size: 9px; color: var(--text2); }
  .alert-msg { font-size: 11px; color: var(--text); line-height: 1.5; }
  .alert-detail { font-size: 10px; color: var(--text2); margin-top: 4px; }

  /* Tool calls panel */
  .bottom-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
  }

  .tool-list {
    padding: 10px;
    height: 240px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .tool-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface2);
    font-size: 11px;
    animation: fadeIn 0.3s ease;
    transition: all 0.2s;
  }

  .tool-item:hover { border-color: var(--muted); }

  .tool-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    flex-shrink: 0;
  }

  .tool-icon.shell { background: rgba(255,107,53,0.15); }
  .tool-icon.fs { background: rgba(124,58,255,0.15); }
  .tool-icon.web { background: rgba(0,255,136,0.1); }
  .tool-icon.memory { background: rgba(255,200,50,0.1); }
  .tool-icon.msg { background: rgba(0,160,255,0.1); }

  .tool-info { flex: 1; overflow: hidden; }
  .tool-name { font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tool-args { font-size: 10px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .tool-status {
    font-size: 9px;
    padding: 2px 7px;
    border-radius: 4px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .tool-status.ok { background: rgba(0,255,136,0.1); color: var(--accent); }
  .tool-status.running { background: rgba(124,58,255,0.15); color: var(--accent2); animation: blink 1s infinite; }
  .tool-status.err { background: rgba(255,45,85,0.1); color: var(--danger); }

  /* Activity chart */
  .chart-area {
    padding: 16px;
    height: 240px;
    display: flex;
    flex-direction: column;
  }

  .chart-bars {
    flex: 1;
    display: flex;
    align-items: flex-end;
    gap: 3px;
    padding-top: 10px;
  }

  .chart-bar-wrap {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    height: 100%;
    justify-content: flex-end;
  }

  .chart-bar {
    width: 100%;
    border-radius: 3px 3px 0 0;
    min-height: 2px;
    transition: height 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    cursor: pointer;
  }

  .chart-bar.normal { background: linear-gradient(180deg, var(--accent), rgba(0,255,136,0.4)); }
  .chart-bar.high { background: linear-gradient(180deg, var(--warn), rgba(255,107,53,0.4)); }
  .chart-bar.peak { background: linear-gradient(180deg, var(--danger), rgba(255,45,85,0.4)); }
  .chart-bar:hover::after {
    content: attr(data-val);
    position: absolute;
    top: -22px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 9px;
    color: var(--text);
    background: var(--surface2);
    padding: 2px 5px;
    border-radius: 3px;
    white-space: nowrap;
  }

  .chart-labels {
    display: flex;
    gap: 3px;
    margin-top: 6px;
  }

  .chart-label {
    flex: 1;
    text-align: center;
    font-size: 8px;
    color: var(--muted);
  }

  /* Memory usage */
  .memory-display {
    padding: 14px 16px;
    height: 240px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .memory-bar-wrap {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .memory-bar-header {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
  }

  .memory-bar-label { color: var(--text2); }
  .memory-bar-val { color: var(--text); font-weight: 600; }

  .memory-bar-bg {
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
  }

  .memory-bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 1s ease;
  }

  .memory-bar-fill.green { background: linear-gradient(90deg, var(--accent), rgba(0,255,136,0.6)); }
  .memory-bar-fill.purple { background: linear-gradient(90deg, var(--accent2), rgba(124,58,255,0.6)); }
  .memory-bar-fill.orange { background: linear-gradient(90deg, var(--warn), rgba(255,107,53,0.6)); }
  .memory-bar-fill.blue { background: linear-gradient(90deg, #00a0ff, rgba(0,160,255,0.6)); }

  /* Config panel */
  .config-section {
    padding: 16px;
  }

  .config-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 11px;
  }

  .config-row:last-child { border-bottom: none; }
  .config-key { color: var(--text2); }
  .config-val { color: var(--accent); font-weight: 500; }
  .config-val.warn { color: var(--warn); }
  .config-val.ok { color: var(--accent); }
  .config-val.muted { color: var(--muted); }

  /* Toggle switch */
  .toggle {
    position: relative;
    width: 32px;
    height: 17px;
    flex-shrink: 0;
  }

  .toggle input { display: none; }

  .toggle-slider {
    position: absolute;
    inset: 0;
    background: var(--muted);
    border-radius: 17px;
    cursor: pointer;
    transition: 0.3s;
  }

  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 11px;
    height: 11px;
    border-radius: 50%;
    background: white;
    top: 3px;
    left: 3px;
    transition: 0.3s;
  }

  .toggle input:checked + .toggle-slider { background: var(--accent); }
  .toggle input:checked + .toggle-slider::before { transform: translateX(15px); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 3px; height: 3px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 2px; }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--muted);
    font-size: 11px;
    gap: 8px;
  }

  .empty-icon { font-size: 28px; opacity: 0.4; }

  .log-path-input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 6px;
    outline: none;
    min-width: 0;
  }
  .log-path-input:focus { border-color: var(--accent); }
  .log-path-input::placeholder { color: var(--muted); }

  .connect-row {
    display: flex;
    gap: 8px;
    align-items: center;
    flex: 1;
  }

  .gateway-input {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 6px;
    outline: none;
    width: 180px;
  }
  .gateway-input:focus { border-color: var(--accent); }

  .btn-connect {
    font-size: 10px;
    color: var(--accent);
    border: 1px solid rgba(0,255,136,0.3);
    background: rgba(0,255,136,0.05);
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-family: var(--mono);
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-connect:hover { background: rgba(0,255,136,0.12); }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header>
    <div class="logo">
      <div class="logo-icon">ğŸ¦</div>
      <div class="logo-text">
        <h1>Ryan's Suit Monitor</h1>
        <span>OpenClaw Â· å…¨æ ˆè°ƒç”¨ç›‘æ§ä¸­æ¢</span>
      </div>
    </div>
    <div class="header-right">
      <div class="connect-row">
        <span style="font-size:10px;color:var(--text2);white-space:nowrap;">æ—¥å¿—æœåŠ¡</span>
        <input class="gateway-input" id="logApiUrl" value="" placeholder="è‡ªåŠ¨æ£€æµ‹..." style="width:220px;" />
        <button class="btn-connect" onclick="startPolling()">å¼€å§‹ç›‘æ§</button>
        <button class="btn-connect" onclick="stopPolling()" style="color:var(--danger);border-color:rgba(255,45,85,0.3);background:rgba(255,45,85,0.05);">åœæ­¢</button>
      </div>
      <div class="status-badge offline" id="statusBadge">
        <div class="status-dot"></div>
        <span id="statusText">æœªè¿æ¥</span>
      </div>
      <div class="time-display" id="clock">--:--:--</div>
    </div>
  </header>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card" style="--accent-color: var(--accent)">
      <div class="stat-label">æ€»è°ƒç”¨æ¬¡æ•°</div>
      <div class="stat-value" style="color:var(--accent)" id="statTotal">0</div>
      <div class="stat-sub">æœ¬æ¬¡ä¼šè¯</div>
    </div>
    <div class="stat-card" style="--accent-color: var(--accent2)">
      <div class="stat-label">Shell å‘½ä»¤</div>
      <div class="stat-value" style="color:var(--accent2)" id="statShell">0</div>
      <div class="stat-sub">exec æ¬¡æ•°</div>
    </div>
    <div class="stat-card" style="--accent-color: #00a0ff">
      <div class="stat-label">æ–‡ä»¶æ“ä½œ</div>
      <div class="stat-value" style="color:#00a0ff" id="statFs">0</div>
      <div class="stat-sub">read + write</div>
    </div>
    <div class="stat-card" style="--accent-color: var(--warn)">
      <div class="stat-label">é¢„è­¦æ•°é‡</div>
      <div class="stat-value" style="color:var(--warn)" id="statAlerts">0</div>
      <div class="stat-sub">éœ€è¦å…³æ³¨</div>
    </div>
    <div class="stat-card" style="--accent-color: #ff9800">
      <div class="stat-label">ç½‘ç»œè¯·æ±‚</div>
      <div class="stat-value" style="color:#ff9800" id="statWeb">0</div>
      <div class="stat-sub">fetch + search</div>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="main-grid">
    <!-- Log stream -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-dot"></div>
          å®æ—¶æ“ä½œæ—¥å¿—
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input class="log-path-input" id="logPath"
            value="/Users/ryansmacmini/.openclaw/logs/gateway.log"
            placeholder="æ—¥å¿—æ–‡ä»¶è·¯å¾„" style="width:280px;" />
          <button class="panel-action" onclick="clearLogs()">æ¸…ç©º</button>
          <button class="panel-action" id="autoScrollBtn" onclick="toggleAutoScroll()" style="color:var(--accent)">â†“ è·Ÿéš</button>
        </div>
      </div>
      <div class="log-stream" id="logStream">
        <div class="empty-state">
          <div class="empty-icon">ğŸ“¡</div>
          <span>è¿æ¥ Gateway åå¼€å§‹æ¥æ”¶æ—¥å¿—</span>
          <span style="color:var(--muted);font-size:10px">æˆ–ä½¿ç”¨æµè§ˆå™¨æ‰©å±•è¯»å–æœ¬åœ°æ—¥å¿—æ–‡ä»¶</span>
        </div>
      </div>
    </div>

    <!-- Alerts -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-dot" style="background:var(--warn)"></div>
          å®‰å…¨é¢„è­¦
        </div>
        <button class="panel-action" onclick="clearAlerts()">æ¸…ç©º</button>
      </div>
      <div class="alerts-list" id="alertsList">
        <div class="empty-state">
          <div class="empty-icon">ğŸ›¡ï¸</div>
          <span>æš‚æ— é¢„è­¦</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Grid -->
  <div class="bottom-grid">
    <!-- Tool calls -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-dot" style="background:var(--accent2)"></div>
          å·¥å…·è°ƒç”¨è®°å½•
        </div>
        <button class="panel-action" onclick="clearTools()">æ¸…ç©º</button>
      </div>
      <div class="tool-list" id="toolList">
        <div class="empty-state">
          <div class="empty-icon">âš™ï¸</div>
          <span>ç­‰å¾…å·¥å…·è°ƒç”¨</span>
        </div>
      </div>
    </div>

    <!-- Activity chart -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-dot"></div>
          è°ƒç”¨é¢‘ç‡ (æœ€è¿‘60ç§’)
        </div>
      </div>
      <div class="chart-area">
        <div class="chart-bars" id="chartBars"></div>
        <div class="chart-labels" id="chartLabels"></div>
      </div>
    </div>

    <!-- System + Config -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-dot" style="background:#00a0ff"></div>
          ç³»ç»ŸçŠ¶æ€ & é¢„è­¦è®¾ç½®
        </div>
      </div>
      <div class="memory-display">
        <div class="memory-bar-wrap">
          <div class="memory-bar-header">
            <span class="memory-bar-label">API Token ç”¨é‡</span>
            <span class="memory-bar-val" id="tokenVal">-- / 256k</span>
          </div>
          <div class="memory-bar-bg">
            <div class="memory-bar-fill green" id="tokenBar" style="width:0%"></div>
          </div>
        </div>
        <div class="memory-bar-wrap">
          <div class="memory-bar-header">
            <span class="memory-bar-label">Shell è°ƒç”¨é¢‘ç‡</span>
            <span class="memory-bar-val" id="shellRateVal">0 æ¬¡/åˆ†</span>
          </div>
          <div class="memory-bar-bg">
            <div class="memory-bar-fill orange" id="shellRateBar" style="width:0%"></div>
          </div>
        </div>
        <div class="config-row" style="border-top:1px solid var(--border);padding-top:10px;">
          <span class="config-key">Shell æ‰§è¡Œé¢„è­¦é˜ˆå€¼</span>
          <span class="config-val">â‰¥ <input id="shellThreshold" type="number" value="5" min="1" max="50"
            style="width:36px;background:var(--surface2);border:1px solid var(--border);color:var(--accent);font-family:var(--mono);font-size:11px;padding:1px 4px;border-radius:4px;text-align:center;outline:none;"> æ¬¡/åˆ†</span>
        </div>
        <div class="config-row">
          <span class="config-key">å±é™©å‘½ä»¤é¢„è­¦</span>
          <label class="toggle"><input type="checkbox" id="dangerAlert" checked><div class="toggle-slider"></div></label>
        </div>
        <div class="config-row">
          <span class="config-key">æ–‡ä»¶åˆ é™¤é¢„è­¦</span>
          <label class="toggle"><input type="checkbox" id="deleteAlert" checked><div class="toggle-slider"></div></label>
        </div>
        <div class="config-row">
          <span class="config-key">æµè§ˆå™¨é€šçŸ¥</span>
          <label class="toggle"><input type="checkbox" id="notifyAlert" onchange="requestNotify()"><div class="toggle-slider"></div></label>
        </div>
        <div class="config-row" style="border:none">
          <span class="config-key">Gateway æ¨¡å‹</span>
          <span class="config-val" id="modelDisplay">moonshot/kimi-k2.5</span>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  ws: null,
  connected: false,
  autoScroll: true,
  stats: { total: 0, shell: 0, fs: 0, alerts: 0, web: 0 },
  activity: new Array(20).fill(0),
  activityLabels: [],
  shellPerMin: 0,
  shellCountWindow: [],
};

// â”€â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(() => {
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString('zh-CN', { hour12: false });
}, 1000);

// â”€â”€â”€ Init chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initChart() {
  const bars = document.getElementById('chartBars');
  const labels = document.getElementById('chartLabels');
  bars.innerHTML = '';
  labels.innerHTML = '';
  for (let i = 0; i < 20; i++) {
    const wrap = document.createElement('div');
    wrap.className = 'chart-bar-wrap';
    const bar = document.createElement('div');
    bar.className = 'chart-bar normal';
    bar.style.height = '2px';
    bar.setAttribute('data-val', '0');
    wrap.appendChild(bar);
    bars.appendChild(wrap);
    const lbl = document.createElement('div');
    lbl.className = 'chart-label';
    lbl.textContent = i % 5 === 0 ? `-${(19-i)*3}s` : '';
    labels.appendChild(lbl);
  }
}
initChart();

function updateChart() {
  const bars = document.querySelectorAll('.chart-bar');
  const max = Math.max(...state.activity, 1);
  bars.forEach((bar, i) => {
    const val = state.activity[i] || 0;
    const pct = (val / max) * 140;
    bar.style.height = Math.max(2, pct) + 'px';
    bar.setAttribute('data-val', val);
    bar.className = 'chart-bar ' + (val > 8 ? 'peak' : val > 4 ? 'high' : 'normal');
  });
}

// Push activity every 3 seconds
setInterval(() => {
  state.activity.shift();
  state.activity.push(0);
  updateChart();

  // Shell rate (per minute)
  const now = Date.now();
  state.shellCountWindow = state.shellCountWindow.filter(t => now - t < 60000);
  state.shellPerMin = state.shellCountWindow.length;
  document.getElementById('shellRateVal').textContent = state.shellPerMin + ' æ¬¡/åˆ†';
  const shellPct = Math.min(100, (state.shellPerMin / 20) * 100);
  document.getElementById('shellRateBar').style.width = shellPct + '%';

  // Shell rate alert
  const threshold = parseInt(document.getElementById('shellThreshold').value) || 5;
  if (state.shellPerMin >= threshold) {
    addAlert('warning', 'Shell è°ƒç”¨é¢‘ç‡è¿‡é«˜', `è¿‡å»1åˆ†é’Ÿæ‰§è¡Œäº† ${state.shellPerMin} æ¬¡ shell å‘½ä»¤`);
  }
}, 3000);

// â”€â”€â”€ æ—¥å¿—è½®è¯¢æ¨¡å¼ï¼ˆæ›¿ä»£ WebSocketï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pollingTimer = null;
let sessionTimer = null;
let lastLogLines = new Set();
let lastLineCount = 0;
let lastSessionMsgId = null;

function connectGateway() { startPolling(); }

function startPolling() {
  // è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€ï¼šå¦‚æœæ˜¯ä»æœ¬åœ°æœåŠ¡å™¨æ‰“å¼€ï¼Œç”¨åŒæºï¼›å¦åˆ™ç”¨é»˜è®¤
  const origin = window.location.origin.startsWith('http') && !window.location.protocol.startsWith('file')
    ? window.location.origin
    : 'http://127.0.0.1:19999';
  const base = document.getElementById('logApiUrl')?.value.trim() || origin;
  const apiBase = base.replace(/\/logs$/, '').replace(/\/$/, '');
  if (pollingTimer) clearInterval(pollingTimer);
  if (sessionTimer) clearInterval(sessionTimer);
  lastLogLines.clear();
  lastLineCount = -1;
  lastSessionMsgId = null;
  state.connected = true;
  setStatus(true);
  addLog('info', 'system', 'SYS', 'æ—¥å¿—ç›‘æ§å·²å¯åŠ¨ â€” è¯»å–å¯¹è¯ & gateway æ—¥å¿—');
  fetchLogs(apiBase + '/logs', true);
  fetchSession(apiBase + '/session', true);
  pollingTimer = setInterval(() => fetchLogs(apiBase + '/logs', false), 3000);
  sessionTimer = setInterval(() => fetchSession(apiBase + '/session', false), 2000);
}

function stopPolling() {
  if (pollingTimer) { clearInterval(pollingTimer); pollingTimer = null; }
  if (sessionTimer) { clearInterval(sessionTimer); sessionTimer = null; }
  state.connected = false;
  setStatus(false);
  addLog('info', 'system', 'SYS', 'ç›‘æ§å·²åœæ­¢');
}

async function fetchLogs(url, isInit) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    const lines = text.trim().split('\n').filter(l => l.trim());
    if (isInit) {
      lines.forEach(l => lastLogLines.add(l));
      lastLineCount = lines.length;
    } else {
      if (lines.length > lastLineCount) {
        lines.slice(lastLineCount).forEach(line => {
          if (!lastLogLines.has(line)) {
            lastLogLines.add(line);
            parseLogLine(line);
          }
        });
        lastLineCount = lines.length;
      }
    }
  } catch(e) {
    if (state.connected) {
      stopPolling();
      addLog('error', 'system', 'ERR', 'æ—¥å¿—æœåŠ¡æ–­å¼€: ' + e.message);
      addAlert('critical', 'æ—¥å¿—æœåŠ¡æ–­å¼€', 'è¯·ç¡®è®¤ log-server.py æ­£åœ¨è¿è¡Œ');
    }
  }
}

async function fetchSession(url, isInit) {
  try {
    const res = await fetch(url);
    if (!res.ok) return;
    const msgs = await res.json();
    if (!msgs.length) return;

    if (isInit) {
      // åˆå§‹åŒ–ï¼šåªè®°å½•æœ€æ–°æ¶ˆæ¯IDï¼Œä¸å›æ”¾å†å²
      lastSessionMsgId = msgs[msgs.length - 1]?.id || null;
      // ä½†æ˜¾ç¤ºæœ€è¿‘5æ¡ä½œä¸ºåˆå§‹çŠ¶æ€
      const recent = msgs.slice(-5);
      recent.forEach(m => parseSessionMsg(m, false));
      return;
    }

    // å¢é‡ï¼šæ‰¾åˆ°æ–°æ¶ˆæ¯
    const lastIdx = lastSessionMsgId ? msgs.findIndex(m => m.id === lastSessionMsgId) : -1;
    const newMsgs = lastIdx >= 0 ? msgs.slice(lastIdx + 1) : [];
    newMsgs.forEach(m => parseSessionMsg(m, true));
    if (newMsgs.length > 0) lastSessionMsgId = msgs[msgs.length - 1].id;
  } catch(e) { /* session è¯»å–å¤±è´¥é™é»˜å¤„ç† */ }
}

function parseSessionMsg(msg, isNew) {
  if (!msg?.message) return;
  const role = msg.message.role;
  const content = msg.message.content || [];

  if (role === 'assistant') {
    // æ‰«æ content æ•°ç»„
    content.forEach(block => {
      if (block.type === 'toolCall') {
        const name = block.name || 'æœªçŸ¥å·¥å…·';
        const args = block.arguments || {};
        handleToolCall(name, args, null);
        if (isNew) addLog('info', 'agent', 'TOOL', `è°ƒç”¨å·¥å…·: ${name}`);
      } else if (block.type === 'text' && isNew) {
        const preview = block.text?.slice(0, 60) || '';
        addLog('info', 'agent', 'TURN', `Agent å›å¤: ${preview}...`);
      }
    });
    // token ç”¨é‡
    const usage = msg.message.usage;
    if (usage?.totalTokens) {
      updateTokens(usage.totalTokens, 256000);
      if (isNew) {
        const cost = usage.cost?.total ? `ï¿¥${usage.cost.total.toFixed(4)}` : 'å…è´¹';
        addLog('info', 'agent', 'TOK',
          `tokens: ${usage.totalTokens.toLocaleString()} (in:${usage.input} out:${usage.output}) ${cost}`);
      }
    }
  } else if (role === 'user' && isNew) {
    // ç”¨æˆ·æ¶ˆæ¯ï¼ˆæ¥è‡ª Telegramï¼‰
    const textBlock = content.find(b => b.type === 'text');
    if (textBlock) {
      const text = textBlock.text || '';
      // è¿‡æ»¤æ‰ metadata å¤´
      const clean = text.replace(/Conversation info[\s\S]*?```\s*/g, '').trim().slice(0, 60);
      if (clean) addLog('info', 'user', 'MSG', `ğŸ“± ç”¨æˆ·: ${clean}`);
    }
  } else if (role === 'toolResult' && isNew) {
    const name = msg.message.toolName || '';
    const ok = !msg.details?.isError;
    addLog(ok ? 'info' : 'error', 'tool', ok ? 'OK' : 'ERR', `å·¥å…·ç»“æœ: ${name} ${ok ? 'âœ“' : 'âœ—'}`);
  }
}

function parseLogLine(line) {
  if (!line.trim()) return;
  // tavily æœç´¢
  if (line.includes('[gateway] tavily:')) {
    const q = line.match(/tavily: "(.+?)"/)?.[1] || '';
    const results = line.match(/â†’ (\d+) results/)?.[1] || '?';
    const ms = line.match(/in (\d+)ms/)?.[1] || '?';
    state.stats.web++; state.stats.total++;
    state.activity[state.activity.length-1]++;
    addLog('info', 'web', 'NET', `tavily: "${q.slice(0,50)}" â†’ ${results}æ¡ (${ms}ms)`);
    addToolItem('ğŸŒ', 'web', 'tavily.search', {query: q}, {results});
    updateStats(); updateChart(); return;
  }
  // webchat è¿æ¥
  if (line.includes('[ws] webchat connected')) {
    addLog('info', 'gateway', 'SYS', 'OpenClaw Webchat å·²è¿æ¥'); return;
  }
  if (line.includes('[ws] webchat disconnected')) {
    const code = line.match(/code=(\d+)/)?.[1] || '?';
    const reason = line.match(/reason=([^\s]+)/)?.[1] || '?';
    addLog('warn', 'gateway', 'SYS', `Webchat æ–­å¼€ code=${code} reason=${reason}`); return;
  }
  // API å“åº”
  if (line.includes('[ws] â‡„ res âœ“')) {
    const method = line.match(/res âœ“ ([\w.]+)/)?.[1] || '';
    const ms = line.match(/âœ“ [\w.]+ (\d+)ms/)?.[1] || '?';
    addLog('info', 'gateway', 'API', `âœ“ ${method} (${ms}ms)`);
    state.stats.total++; updateStats(); return;
  }
  if (line.includes('[ws] â‡„ res âœ—')) {
    const method = line.match(/res âœ— ([\w.]+)/)?.[1] || '';
    const err = line.match(/errorMessage=(.+?)(?= conn=|$)/)?.[1] || '';
    addLog('error', 'gateway', 'ERR', `âœ— ${method}: ${err.slice(0,80)}`);
    addAlert('warning', `APIé”™è¯¯: ${method}`, err.slice(0,100)); return;
  }
  // reload/plugins
  if (line.includes('[reload]')) { addLog('info', 'system', 'CFG', 'é…ç½®å·²é‡è½½'); return; }
  if (line.includes('[plugins]')) {
    const msg = line.replace(/^.*?\[plugins\]\s*/, '').slice(0,100);
    addLog('info', 'plugins', 'PLG', msg); return;
  }
  // å…¶ä»– gateway
  if (line.includes('[gateway]')) {
    const msg = line.replace(/^.*?\[gateway\]\s*/, '').slice(0,100);
    addLog('info', 'gateway', 'GW', msg); return;
  }
  // å¿½ç•¥å™ªéŸ³
  if (line.includes('typing TTL')) return;
  // å…œåº•
  const msg = line.slice(0,120);
  if (msg.trim()) addLog('info', 'system', 'LOG', msg);
}

function handleGatewayEvent(data) {
  const type = data.type || data.event || '';

  if (type === 'tool_call' || type === 'tool.call') {
    const tool = data.tool || data.name || 'æœªçŸ¥å·¥å…·';
    const args = data.args || data.input || {};
    handleToolCall(tool, args, data.result);
  } else if (type === 'agent_turn' || type === 'turn') {
    addLog('info', 'agent', 'TURN', `Agent å“åº” â€” ${data.tokens || '?'} tokens`);
    const tok = parseInt(data.tokens || 0);
    if (tok > 0) updateTokens(tok, 256000);
  } else if (type === 'log') {
    const level = data.level || 'info';
    addLog(level, data.source || 'gateway', level.toUpperCase(), data.message || JSON.stringify(data));
  } else if (type === 'error') {
    addLog('error', 'gateway', 'ERR', data.message || JSON.stringify(data));
    addAlert('critical', 'Gateway é”™è¯¯', data.message || 'æœªçŸ¥é”™è¯¯');
  } else {
    // Generic event
    addLog('info', type || 'event', 'EVT', JSON.stringify(data).slice(0, 100));
    state.stats.total++;
    state.activity[state.activity.length - 1]++;
    updateStats();
  }
}

function handleToolCall(tool, args, result) {
  state.stats.total++;
  state.activity[state.activity.length - 1]++;

  const toolLower = tool.toLowerCase();
  let icon = 'âš™ï¸';
  let cls = '';

  if (toolLower.includes('shell') || toolLower.includes('exec') || toolLower.includes('bash')) {
    icon = 'ğŸ’»'; cls = 'shell';
    state.stats.shell++;
    state.shellCountWindow.push(Date.now());

    // Danger check
    const cmd = args.command || args.cmd || JSON.stringify(args);
    if (document.getElementById('dangerAlert').checked) {
      const dangerous = ['rm -rf', 'sudo rm', '> /dev/', 'format', 'mkfs', 'dd if=', ':(){'];
      if (dangerous.some(d => cmd.includes(d))) {
        addAlert('critical', 'âš ï¸ å±é™©å‘½ä»¤æ£€æµ‹', `æ‰§è¡Œäº†é«˜å±å‘½ä»¤: ${cmd.slice(0, 80)}`);
      }
    }
    addLog('tool', 'shell', 'EXEC', `<span class="cmd">${(args.command || args.cmd || JSON.stringify(args)).slice(0, 80)}</span>`);

  } else if (toolLower.includes('file') || toolLower.includes('fs') || toolLower.includes('read') || toolLower.includes('write')) {
    icon = 'ğŸ“'; cls = 'fs';
    state.stats.fs++;
    const path = args.path || args.file || '';
    if (document.getElementById('deleteAlert').checked && (toolLower.includes('delete') || toolLower.includes('remove'))) {
      addAlert('warning', 'æ–‡ä»¶åˆ é™¤æ“ä½œ', `æ­£åœ¨åˆ é™¤: <span class="path">${path}</span>`);
    }
    addLog('tool', 'fs', 'FILE', `<span class="path">${path}</span> [${tool}]`);

  } else if (toolLower.includes('web') || toolLower.includes('fetch') || toolLower.includes('search') || toolLower.includes('http')) {
    icon = 'ğŸŒ'; cls = 'web';
    state.stats.web++;
    addLog('info', 'web', 'NET', `${tool} â†’ ${args.url || args.query || ''}`.slice(0, 80));

  } else if (toolLower.includes('memory') || toolLower.includes('recall')) {
    icon = 'ğŸ§ '; cls = 'memory';
    addLog('info', 'memory', 'MEM', `${tool}: ${JSON.stringify(args).slice(0, 60)}`);

  } else if (toolLower.includes('message') || toolLower.includes('telegram') || toolLower.includes('send')) {
    icon = 'ğŸ’¬'; cls = 'msg';
    addLog('info', 'msg', 'MSG', `å‘é€æ¶ˆæ¯: ${JSON.stringify(args).slice(0, 60)}`);
  } else {
    addLog('info', 'tool', 'TOOL', `${tool}: ${JSON.stringify(args).slice(0, 70)}`);
  }

  updateStats();
  updateChart();
  addToolItem(icon, cls, tool, args, result);
}

// â”€â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(online) {
  const badge = document.getElementById('statusBadge');
  const text = document.getElementById('statusText');
  badge.className = 'status-badge ' + (online ? 'online' : 'offline');
  text.textContent = online ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
}

function updateStats() {
  document.getElementById('statTotal').textContent = state.stats.total;
  document.getElementById('statShell').textContent = state.stats.shell;
  document.getElementById('statFs').textContent = state.stats.fs;
  document.getElementById('statAlerts').textContent = state.stats.alerts;
  document.getElementById('statWeb').textContent = state.stats.web;
}

function updateTokens(used, max) {
  const pct = Math.min(100, (used / max) * 100);
  document.getElementById('tokenVal').textContent = `${used.toLocaleString()} / ${(max/1000).toFixed(0)}k`;
  document.getElementById('tokenBar').style.width = pct + '%';
  document.getElementById('tokenBar').className = 'memory-bar-fill ' + (pct > 80 ? 'orange' : 'green');
}

function addLog(level, source, tag, msg) {
  const stream = document.getElementById('logStream');
  const empty = stream.querySelector('.empty-state');
  if (empty) empty.remove();

  const t = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit' });
  const el = document.createElement('div');
  el.className = `log-entry ${level}`;
  el.innerHTML = `
    <span class="log-time">${t}</span>
    <span class="log-level">${tag}</span>
    <span class="log-source">${source}</span>
    <span class="log-msg">${msg}</span>
  `;
  stream.appendChild(el);

  // Keep max 200 entries
  while (stream.children.length > 200) stream.removeChild(stream.firstChild);

  if (state.autoScroll) stream.scrollTop = stream.scrollHeight;
}

function addAlert(level, title, detail) {
  const list = document.getElementById('alertsList');
  const empty = list.querySelector('.empty-state');
  if (empty) empty.remove();

  state.stats.alerts++;
  updateStats();

  const t = new Date().toLocaleTimeString('zh-CN', { hour12: false });
  const el = document.createElement('div');
  el.className = `alert-item ${level}`;
  el.innerHTML = `
    <div class="alert-header">
      <span class="alert-type">${level === 'critical' ? 'ğŸ”´ ä¸¥é‡' : level === 'warning' ? 'ğŸŸ  è­¦å‘Š' : 'ğŸŸ¢ ä¿¡æ¯'}</span>
      <span class="alert-time">${t}</span>
    </div>
    <div class="alert-msg">${title}</div>
    <div class="alert-detail">${detail}</div>
  `;
  el.onclick = () => el.remove();
  list.insertBefore(el, list.firstChild);

  // Browser notification
  if (document.getElementById('notifyAlert').checked && level === 'critical') {
    new Notification('Ryan\'s Suit é¢„è­¦', { body: title + '\n' + detail, icon: 'ğŸ¦' });
  }

  while (list.children.length > 50) list.removeChild(list.lastChild);
}

function addToolItem(icon, cls, name, args, result) {
  const list = document.getElementById('toolList');
  const empty = list.querySelector('.empty-state');
  if (empty) empty.remove();

  const argStr = JSON.stringify(args).replace(/[{}"]/g, '').slice(0, 50);
  const status = result?.error ? 'err' : result ? 'ok' : 'running';
  const statusLabel = status === 'err' ? 'ERR' : status === 'ok' ? 'OK' : '...';

  const el = document.createElement('div');
  el.className = 'tool-item';
  el.innerHTML = `
    <div class="tool-icon ${cls}">${icon}</div>
    <div class="tool-info">
      <div class="tool-name">${name}</div>
      <div class="tool-args">${argStr}</div>
    </div>
    <span class="tool-status ${status}">${statusLabel}</span>
  `;
  list.insertBefore(el, list.firstChild);
  while (list.children.length > 50) list.removeChild(list.lastChild);
}

function clearLogs() {
  document.getElementById('logStream').innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“¡</div><span>æ—¥å¿—å·²æ¸…ç©º</span></div>';
}

function clearAlerts() {
  state.stats.alerts = 0;
  updateStats();
  document.getElementById('alertsList').innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ›¡ï¸</div><span>æš‚æ— é¢„è­¦</span></div>';
}

function clearTools() {
  document.getElementById('toolList').innerHTML = '<div class="empty-state"><div class="empty-icon">âš™ï¸</div><span>ç­‰å¾…å·¥å…·è°ƒç”¨</span></div>';
}

function toggleAutoScroll() {
  state.autoScroll = !state.autoScroll;
  const btn = document.getElementById('autoScrollBtn');
  btn.style.color = state.autoScroll ? 'var(--accent)' : 'var(--muted)';
  btn.textContent = state.autoScroll ? 'â†“ è·Ÿéš' : 'â—‹ æš‚åœ';
}

function requestNotify() {
  if (document.getElementById('notifyAlert').checked) {
    Notification.requestPermission();
  }
}

// è‡ªåŠ¨å¯åŠ¨æ—¥å¿—ç›‘æ§
setTimeout(startPolling, 500);
</script>
</body>
</html>
